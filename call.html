<!-- call.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>オンラインミーティング - 協同学習支援</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>オンラインミーティング</h2>
        <p>自身のミーティングIDをメンバーに共有し、相手のIDを入力して「接続」ボタンを押してください。</p>
        
        <div>
            <h4>あなたのミーティングID: <span id="my-id" style="color: #d9534f; background-color: #fcf8e3; padding: 2px 5px; border-radius: 3px;"></span></h4>
        </div>

        <div>
            <input type="text" id="their-id" placeholder="接続先のミーティングID">
            <button onclick="makeCall()">接続</button>
        </div>

        <div class="video-container">
            <video id="my-video" muted="true" autoplay playsinline></video>
            <video id="their-video" autoplay playsinline></video>
        </div>
        <a href="index.html" class="back-link">トップページに戻る</a>
    </div>

    <script>
        const myVideo = document.getElementById('my-video');
        const theirVideo = document.getElementById('their-video');
        const myIdSpan = document.getElementById('my-id');
        const theirIdInput = document.getElementById('their-id');
        const peer = new Peer();
        let myStream;

        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                myStream = stream;
                myVideo.srcObject = stream;
            }).catch(error => {
                alert('この機能を利用するには、カメラとマイクへのアクセスを許可する必要があります。');
            });

        peer.on('open', id => {
            myIdSpan.textContent = id;
        });

        function makeCall() {
            const theirID = theirIdInput.value;
            const call = peer.call(theirID, myStream);
            setupCall(call);
        }

        peer.on('call', call => {
            if (confirm(`${call.peer} からミーティングへの参加リクエストがあります。承認しますか？`)) {
                call.answer(myStream);
                setupCall(call);
            } else {
                console.log('着信を拒否しました。');
            }
        });
        
        function setupCall(call) {
            call.on('stream', stream => {
                theirVideo.srcObject = stream;
            });
            call.on('close', () => {
                theirVideo.srcObject = null;
                alert('ミーティングが終了しました。');
            });
        }
    </script>
</body>
</html>