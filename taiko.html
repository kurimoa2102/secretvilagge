<!-- taiko.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リズム感トレーニング - 協同学習支援</title>
    <!-- このページ専用のスタイルシート読み込みは削除 -->
</head>
<body>

    <!-- ▼▼▼ ここにお前のダチのHTMLコードを、<head>や<body>のタグも含めて全部貼り付けろ！ ▼▼▼ -->
    <!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digital Learning System v5.1</title>
    <!-- 圧縮解凍ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <style>
        /* --- デザイン: 学習ツール風 (方眼紙・フラット) --- */
        @font-face { font-family: 'Academic'; src: local('Arial'), local('Helvetica'); }
        body {
            margin: 0; padding: 0;
            background-color: #ffffff;
            background-image: 
                linear-gradient(#e0e0e0 1px, transparent 1px),
                linear-gradient(90deg, #e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: 'Academic', sans-serif;
            overflow: hidden; height: 100vh; width: 100vw;
            user-select: none; -webkit-user-select: none; touch-action: none;
            color: #333;
        }
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; }

        /* --- 設定画面 --- */
        #setup-screen { background: rgba(245, 245, 245, 0.95); z-index: 100; justify-content: center; }
        .panel {
            background: #fff; padding: 25px; border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #ccc;
            text-align: center; width: 85%; max-width: 650px; max-height: 90vh; overflow-y: auto;
        }
        h1 { margin: 0 0 15px; color: #2c3e50; border-bottom: 2px solid #3498db; display:inline-block; font-size: 22px; padding-bottom:5px;}
        
        .mode-select { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        .mode-btn { padding: 8px 16px; border: 1px solid #3498db; background: #fff; color: #3498db; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 1; font-size: 14px; }
        .mode-btn.active { background: #3498db; color: white; }
        
        .input-area { text-align: left; margin-bottom: 15px; background: #f9f9f9; padding: 12px; border-radius: 4px; border: 1px solid #eee; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; font-size: 13px; }
        input, select, textarea { font-family: monospace; font-size: 12px; border: 1px solid #ccc; padding: 5px; width: 100%; box-sizing: border-box; }
        textarea { height: 80px; }
        
        .start-btn {
            background: #27ae60; color: white; border: none; width: 100%;
            padding: 12px; font-size: 18px; border-radius: 4px;
            font-weight: bold; cursor: pointer; margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .start-btn:active { transform: translateY(1px); box-shadow: none; }

        .config-btn {
            background: #7f8c8d; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 12px;
        }

        /* --- 設定モーダル --- */
        #config-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 200; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; padding: 20px; width: 85%; max-width: 400px;
            border-radius: 5px; border: 1px solid #999; text-align: left;
        }
        .config-row { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .close-btn { background: #3498db; color: white; border: none; padding: 10px; width: 100%; margin-top: 10px; cursor: pointer; border-radius: 4px; }

        /* --- 学習画面 --- */
        #session-screen { background: #fff; flex-direction: row; }
        .student-area { position: relative; width: 50%; height: 100%; overflow: hidden; background: transparent; border-right: 1px solid #ddd; }
        #session-screen.single-mode #p2-area { display: none; }
        #session-screen.single-mode #p1-area { width: 100%; border: none; }

        .top-ui { position: absolute; top: 0; left: 0; width: 100%; height: 45px; background: #f5f5f5; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-sizing: border-box; pointer-events: none; z-index: 40; }
        .gauge-frame { position: relative; width: 120px; height: 10px; background: #e0e0e0; border: 1px solid #aaa; border-radius: 5px; overflow: hidden; }
        .gauge-bar { width: 0%; height: 100%; background: #f39c12; transition: width 0.1s linear; }
        .gauge-bar.full { background: #2ecc71; } 
        .score-text { font-family: monospace; font-size: 16px; font-weight: bold; color: #333; }

        .timeline-container { position: absolute; top: 60px; left: 0; width: 100%; height: 120px; background: #fff; border-top: 2px solid #555; border-bottom: 2px solid #555; overflow: hidden; }
        .target-zone { position: absolute; top: 50%; left: 20%; transform: translate(-50%, -50%); width: 60px; height: 60px; border: 3px solid #555; border-radius: 50%; z-index: 10; }

        .problem-node { position: absolute; top: 50%; width: 50px; height: 50px; transform: translate(-50%, -50%); z-index: 5; will-change: transform; }
        .node-inner { width: 100%; height: 100%; border-radius: 50%; border: 2px solid #fff; box-sizing: border-box; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .type-a .node-inner { background: #e74c3c; } 
        .type-b .node-inner { background: #3498db; } 
        .big { width: 75px; height: 75px; }

        .streak-display { position: absolute; top: 70px; left: 8%; font-size: 30px; font-weight: bold; color: #2ecc71; opacity: 0; z-index: 20; pointer-events: none; }
        .eval-display { position: absolute; top: 30px; left: 20%; transform: translateX(-50%); font-size: 20px; font-weight: bold; z-index: 25; pointer-events: none; opacity: 0; text-shadow: 0 0 2px white; }

        .input-pad { position: absolute; bottom: 0; width: 100%; height: calc(100% - 180px); background: rgba(0,0,0,0.02); display: flex; justify-content: center; align-items: center; touch-action: none; }
        .pad-surface { width: 160px; height: 160px; background: #e74c3c; border-radius: 50%; border: 8px solid #bdc3c7; box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; pointer-events: auto; transition: transform 0.05s; }
        .pad-surface::after { content: 'INPUT'; position: absolute; top:50%; left:50%; transform: translate(-50%,-50%); color: rgba(255,255,255,0.6); font-weight:bold; pointer-events:none; font-size:12px; }

        #abort-btn { position: absolute; top: 5px; left: 50%; transform: translateX(-50%); z-index: 100; background: #333; color: #fff; border: 1px solid #ccc; padding: 4px 12px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 11px; }

        #panic-btn { position: fixed; bottom: 15px; right: 15px; width: 30px; height: 30px; background: rgba(0, 0, 0, 0.1); border-radius: 50%; cursor: pointer; z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 14px; color: rgba(0,0,0,0.3); border: 1px solid rgba(0,0,0,0.1); }
        #panic-btn:hover { background: rgba(0,0,0,0.3); color: white; }

        #result-screen { background: rgba(255,255,255,0.95); z-index: 60; justify-content: center; color: #333;}
        .report-box { border: 1px solid #999; padding: 30px; background: #fff; width: 80%; text-align: center; border-radius: 5px;}
        .result-row { display: flex; justify-content: space-around; width: 100%; margin-top: 20px; }
        .result-col { text-align: center; width: 45%; background: #f9f9f9; padding: 15px; border-radius: 5px; border: 1px solid #eee; }
        .winner { border: 2px solid #f1c40f; background: #fef9e7; }

        @keyframes flash { 0%{opacity:1; transform:translate(-50%,0);} 100%{opacity:0; transform:translate(-50%,-20px);} }
    </style>
</head>
<body>

    <div id="panic-btn" onclick="triggerPanic()" title="Reference Material">?</div>

    <div id="setup-screen" class="screen" style="display:flex;">
        <div class="panel">
            <h1 style="color:#2c3e50;">Digital Learning System v5.1</h1>
            
            <div class="mode-select">
                <div class="mode-btn active" id="btn-1p" onclick="setMode(1)">Individual Study</div>
                <div class="mode-btn" id="btn-2p" onclick="setMode(2)">Pair Programming</div>
            </div>

            <div class="input-area">
                <label>1. Audio Material (.mp3/.ogg)</label>
                <input type="file" id="audio-file" accept="audio/*">
            </div>

            <div class="input-area">
                <label>2. Curriculum Code (Generated or Raw TJA)</label>
                <div style="display:flex; gap:10px; margin-bottom:5px;">
                    <select id="grade-select" style="flex:1;">
                        <option value="Oni">Advanced</option>
                        <option value="Hard">Intermediate</option>
                        <option value="Normal">Basic</option>
                        <option value="Easy">Intro</option>
                    </select>
                </div>
                <!-- 変換コードもRaw TJAも受け付ける入力欄 -->
                <textarea id="tja-input" placeholder="Paste generated code (CODE::...) or raw TJA here..."></textarea>
            </div>

            <div style="text-align: right;">
                <button class="config-btn" onclick="openConfig()">System Config</button>
            </div>

            <button class="start-btn" onclick="prepareGame()">Start Session</button>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="config-modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">System Configuration</h3>
            
            <div class="config-row">
                <label style="display:block;">Latency Adjustment (sec):</label>
                <input type="number" id="cfg-offset" value="1.50" step="0.01" style="width:100px;">
                <div style="font-size:10px; color:#666; margin-top:2px;">Positive value delays the items.</div>
            </div>

            <div class="config-row">
                <label style="display:block;">Input Pad Size (1P only):</label>
                <input type="range" id="cfg-pad-size" min="100" max="350" value="200" style="width:100%;">
            </div>

            <div class="config-row">
                <label style="display:block;">Auto Solver:</label>
                <input type="checkbox" id="cfg-auto"> <span style="font-size:12px;">Enable AI demonstration</span>
            </div>

            <div class="config-row" style="border:none;">
                <label style="display:block;">Reference URLs (Panic Button):</label>
                <textarea id="cfg-urls" style="height:60px; font-family:monospace;"></textarea>
                <div style="font-size:10px; color:#666;">One URL per line.</div>
            </div>

            <button class="close-btn" onclick="closeConfig()">Save & Close</button>
        </div>
    </div>

    <!-- Session Screen -->
    <div id="session-screen" class="screen">
        <button id="abort-btn" onclick="quitGame()">Abort</button>

        <!-- P1 -->
        <div id="p1-area" class="student-area">
            <div class="top-ui">
                <div style="color:#e74c3c; font-weight:bold;">Student A</div>
                <div class="gauge-frame"><div class="gauge-bar" id="p1-gauge"></div></div>
                <div class="score-text" id="p1-score">0</div>
            </div>
            <div class="timeline-container">
                <div class="target-zone"></div>
                <div class="problem-layer" id="p1-problems"></div>
                <div class="eval-display" id="p1-judge"></div>
            </div>
            <div class="streak-display" id="p1-combo">0</div>
            <div class="input-pad" id="p1-ctrl"><div class="pad-surface" id="p1-drum"></div></div>
        </div>

        <!-- P2 -->
        <div id="p2-area" class="student-area">
            <div class="top-ui">
                <div style="color:#3498db; font-weight:bold;">Student B</div>
                <div class="gauge-frame"><div class="gauge-bar" id="p2-gauge"></div></div>
                <div class="score-text" id="p2-score">0</div>
            </div>
            <div class="timeline-container">
                <div class="target-zone"></div>
                <div class="problem-layer" id="p2-problems"></div>
                <div class="eval-display" id="p2-judge"></div>
            </div>
            <div class="streak-display" id="p2-combo">0</div>
            <div class="input-pad" id="p2-ctrl"><div class="pad-surface" id="p2-drum"></div></div>
        </div>
    </div>

    <!-- Report Screen -->
    <div id="result-screen" class="screen">
        <div class="report-box">
            <h2 style="color:#f39c12;">Session Report</h2>
            <div class="result-row">
                <div class="result-col" id="res-p1">
                    <h3 style="color:#e74c3c; margin:0;">Student A</h3>
                    <div style="font-size:24px; font-weight:bold; margin:10px 0;" id="res-score-p1">0</div>
                    <div id="res-rank-p1" style="font-weight:bold; font-size:14px; color:#555;"></div>
                </div>
                <div class="result-col" id="res-p2">
                    <h3 style="color:#3498db; margin:0;">Student B</h3>
                    <div style="font-size:24px; font-weight:bold; margin:10px 0;" id="res-score-p2">0</div>
                    <div id="res-rank-p2" style="font-weight:bold; margin:10px 0;"></div>
                </div>
            </div>
            <button class="start-btn" onclick="backToSetup()" style="margin-top:30px; width:200px;">Return</button>
        </div>
    </div>

    <audio id="bgm"></audio>

<script>
    // --- Constant Logic ---
    const JUDGE_X_PERCENT = 20;
    const SCROLL_SPEED_BASE = 240; 
    const START_DELAY = 2.5; 
    const HIT_GOOD = 0.050, HIT_OK = 0.120, HIT_BAD = 0.160;

    // --- Japanese Study URLs ---
    let panicUrls = [
        "https://www.google.com/search?q=中1+数学+公式まとめ",
        "https://www.google.com/search?q=英単語+覚え方+効率",
        "https://www.google.com/search?q=理科+元素記号+一覧",
        "https://www.google.com/search?q=日本史+年表+語呂合わせ"
    ];

    // --- State Variables ---
    let mode = 1; 
    let audioCtx;
    let bgm = document.getElementById('bgm');
    let notesData = [];
    let isPlaying = false;
    let animId;
    let startTime = 0;
    let totalNotes = 0;
    let isAuto = false;

    class StudentState {
        constructor() { this.score=0; this.combo=0; this.maxCombo=0; this.gauge=0; this.good=0; this.ok=0; this.bad=0; }
    }
    let p1State, p2State;

    const dom = {
        p1: { notes:document.getElementById('p1-problems'), score:document.getElementById('p1-score'), combo:document.getElementById('p1-combo'), judge:document.getElementById('p1-judge'), gauge:document.getElementById('p1-gauge'), drumArea:document.getElementById('p1-ctrl'), drumFace:document.getElementById('p1-drum') },
        p2: { notes:document.getElementById('p2-problems'), score:document.getElementById('p2-score'), combo:document.getElementById('p2-combo'), judge:document.getElementById('p2-judge'), gauge:document.getElementById('p2-gauge'), drumArea:document.getElementById('p2-ctrl'), drumFace:document.getElementById('p2-drum') }
    };

    // --- Initialization ---
    window.onload = () => {
        const saved = localStorage.getItem('dls_v5_urls');
        if(saved) panicUrls = JSON.parse(saved);
        document.getElementById('cfg-urls').value = panicUrls.join('\n');
    };

    function setMode(m) {
        mode = m;
        document.getElementById('btn-1p').className = m===1 ? 'mode-btn active' : 'mode-btn';
        document.getElementById('btn-2p').className = m===2 ? 'mode-btn active' : 'mode-btn';
    }

    // --- Config & Panic ---
    function openConfig() { document.getElementById('config-modal').style.display = 'flex'; }
    function closeConfig() {
        const raw = document.getElementById('cfg-urls').value;
        panicUrls = raw.split('\n').filter(u=>u.trim()!=="");
        localStorage.setItem('dls_v5_urls', JSON.stringify(panicUrls));
        document.getElementById('config-modal').style.display = 'none';
    }
    function triggerPanic() {
        if(panicUrls.length>0) window.location.href = panicUrls[Math.floor(Math.random()*panicUrls.length)];
        else alert("No URLs configured.");
    }

    // --- Audio ---
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    function playSE(type) {
        initAudio();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        if (type === 'type-a') {
            osc.frequency.setValueAtTime(180, t); osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.1);
            gain.gain.setValueAtTime(1, t); gain.gain.linearRampToValueAtTime(0, t+0.1);
        } else {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(600, t); osc.frequency.exponentialRampToValueAtTime(100, t + 0.05);
            gain.gain.setValueAtTime(0.5, t); gain.gain.linearRampToValueAtTime(0, t+0.05);
        }
        osc.start(); osc.stop(t+0.1);
    }

    // --- Parsing (Raw TJA or Compressed) ---
    function parseInput(text, courseName) {
        let rawTJA = text;
        
        // 圧縮コード(CODE::)かチェック
        if(text.startsWith("CODE::")) {
            try {
                const compressed = text.substring(6);
                rawTJA = LZString.decompressFromBase64(compressed);
                if(!rawTJA) throw new Error("Decompression failed");
            } catch(e) {
                alert("Invalid Code.");
                return [];
            }
        }

        return parseTJA(rawTJA, courseName);
    }

    function parseTJA(text, courseName) {
        const lines = text.split(/\r?\n/);
        let bpm = 120, offset = 0;
        lines.forEach(l => {
            const m = l.match(/^([A-Z]+):(.+)/);
            if(m) { if(m[1].trim()==='BPM') bpm=parseFloat(m[2]); if(m[1].trim()==='OFFSET') offset=parseFloat(m[2]); }
        });
        let targetLines=[], currentCourse='Oni', isTarget=false, foundStart=false;
        for(let l of lines) {
            l=l.trim(); if(!l) continue;
            if(l.startsWith('COURSE:')) { currentCourse=l.split(':')[1].trim(); isTarget=(currentCourse.toLowerCase()===courseName.toLowerCase()); continue; }
            if(l==='#START') { if(!isTarget && currentCourse==='Oni' && courseName==='Oni') isTarget=true; if(isTarget) foundStart=true; continue; }
            if(l==='#END') { if(isTarget) break; continue; }
            if(isTarget && foundStart) targetLines.push(l);
        }
        let list=[], curBPM=bpm, curScroll=1.0, curMeasure=4/4, curTime=-offset, buffer="";
        for(let l of targetLines) {
            if(l.startsWith('#')) {
                if(buffer) { curTime=processBuffer(buffer, list, curBPM, curMeasure, curTime, curScroll); buffer=""; }
                if(l.startsWith('#BPMCHANGE')) curBPM=parseFloat(l.split(' ')[1]);
                else if(l.startsWith('#SCROLL')) curScroll=parseFloat(l.split(' ')[1]);
                else if(l.startsWith('#MEASURE')) { const p=l.split(' ')[1].split('/'); curMeasure=parseInt(p[0])/parseInt(p[1]); }
                else if(l.startsWith('#DELAY')) curTime+=parseFloat(l.split(' ')[1]);
                continue;
            }
            if(l.endsWith(',')) { buffer+=l.slice(0,-1); curTime=processBuffer(buffer, list, curBPM, curMeasure, curTime, curScroll); buffer=""; }
            else { buffer+=l; }
        }
        return list.sort((a,b)=>a.time - b.time);
    }
    function processBuffer(data, list, bpm, measure, startT, scroll) {
        if(!data.length) return startT;
        const duration=(60/bpm)*4*measure, unit=duration/data.length;
        for(let i=0; i<data.length; i++) {
            const c=data[i]; let type=null;
            if(c==='1') type='type-a'; else if(c==='2') type='type-b'; else if(c==='3') type='type-a big'; else if(c==='4') type='type-b big'; else if(c==='5'||c==='6') type='type-a';
            if(type) list.push({ time:startT+unit*i, type:type, bpm:bpm, scroll:scroll, doneA:false, doneB:false, elA:null, elB:null });
        }
        return startT+duration;
    }

    // --- Session Control ---
    function prepareGame() {
        const file = document.getElementById('audio-file').files[0];
        if(!file && !bgm.src) { alert("Error: Audio file not selected."); return; }
        const inputText = document.getElementById('tja-input').value;
        if(!inputText.trim()) { alert("Error: Curriculum data empty."); return; }
        const course = document.getElementById('grade-select').value;
        
        notesData = parseInput(inputText, course);
        if(!notesData.length) { alert("Error: No data found."); return; }

        isAuto = document.getElementById('cfg-auto').checked;
        const padSize = document.getElementById('cfg-pad-size').value;
        dom.p1.drumFace.style.width = dom.p1.drumFace.style.height = `${padSize}px`;

        totalNotes = notesData.length;
        p1State = new StudentState(); p2State = new StudentState();

        document.getElementById('setup-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('session-screen').style.display = 'flex';
        
        if(mode === 1) {
            document.getElementById('session-screen').classList.add('single-mode');
            document.getElementById('p2-area').style.display = 'none';
            document.getElementById('p1-area').style.width = '100%';
        } else {
            document.getElementById('session-screen').classList.remove('single-mode');
            document.getElementById('p2-area').style.display = 'block';
            document.getElementById('p1-area').style.width = '50%';
            dom.p1.drumFace.style.width = dom.p1.drumFace.style.height = '150px'; // 2P default size
        }

        updateUI(1); updateUI(2);
        dom.p1.notes.innerHTML = ''; dom.p2.notes.innerHTML = '';

        if(file) bgm.src = URL.createObjectURL(file);
        initAudio();
        
        const now = performance.now();
        startTime = now + (START_DELAY * 1000);
        isPlaying = true;
        
        setTimeout(() => { bgm.currentTime = 0; bgm.play(); }, START_DELAY * 1000);
        gameLoop();
    }

    function gameLoop() {
        if(!isPlaying) return;
        const now = performance.now();
        const manualOffset = parseFloat(document.getElementById('cfg-offset').value);
        let curTime;
        if (now < startTime) curTime = (now - startTime)/1000 - manualOffset;
        else {
            if(!bgm.paused) curTime = bgm.currentTime - manualOffset;
            else curTime = (now - startTime)/1000 - manualOffset;
        }

        const judgePx = (dom.p1.notes.clientWidth) * (JUDGE_X_PERCENT / 100);
        const spawnX = dom.p1.notes.clientWidth + 200;
        const deleteX = -100;

        for(let note of notesData) {
            const diffTime = note.time - curTime;
            
            if(isAuto) {
                if(!note.doneA && diffTime <= 0) input(1, note.type.includes('type-a')?'type-a':'type-b', true);
                if(mode===2 && !note.doneB && diffTime <= 0) input(2, note.type.includes('type-a')?'type-a':'type-b', true);
            }

            const moveSpeed = (note.bpm / 60) * note.scroll * SCROLL_SPEED_BASE;
            const x = judgePx + (diffTime * moveSpeed);

            if(x > deleteX && x < spawnX) {
                if(!note.doneA) {
                    if(!note.elA) {
                        const el = document.createElement('div'); el.className = `problem-node ${note.type}`;
                        el.innerHTML = '<div class="node-inner"></div>';
                        dom.p1.notes.appendChild(el); note.elA = el;
                        if(note.type.includes('big')) el.classList.add('big');
                    }
                    note.elA.style.transform = `translate(${x}px, -50%)`;
                } else if(note.elA) { note.elA.remove(); note.elA = null; }

                if(mode===2 && !note.doneB) {
                    if(!note.elB) {
                        const el = document.createElement('div'); el.className = `problem-node ${note.type}`;
                        el.innerHTML = '<div class="node-inner"></div>';
                        dom.p2.notes.appendChild(el); note.elB = el;
                        if(note.type.includes('big')) el.classList.add('big');
                    }
                    note.elB.style.transform = `translate(${x}px, -50%)`;
                } else if(note.elB) { note.elB.remove(); note.elB = null; }
            } else {
                if(note.elA) { note.elA.remove(); note.elA = null; }
                if(note.elB) { note.elB.remove(); note.elB = null; }
            }

            if(diffTime < -HIT_BAD) {
                if(!note.doneA) { note.doneA=true; processResult(1, 0, null); }
                if(mode===2 && !note.doneB) { note.doneB=true; processResult(2, 0, null); }
            }
        }

        if(bgm.ended) finishGame();
        else animId = requestAnimationFrame(gameLoop);
    }

    function input(playerId, type, auto=false) {
        if(!isPlaying) return;
        if(!auto) playSE(type);

        const now = performance.now();
        const manualOffset = parseFloat(document.getElementById('cfg-offset').value);
        let curTime;
        if (now < startTime) curTime = (now - startTime)/1000 - manualOffset;
        else curTime = bgm.currentTime - manualOffset;

        let target = null;
        for(let note of notesData) {
            if(playerId===1 && note.doneA) continue;
            if(playerId===2 && note.doneB) continue;
            const isTypeA = note.type.includes('type-a');
            const inTypeA = (type === 'type-a');
            if(isTypeA !== inTypeA) continue;
            const diff = Math.abs(note.time - curTime);
            if(diff <= HIT_BAD) { target = note; break; }
        }

        if(target) {
            if(playerId===1) target.doneA=true; else target.doneB=true;
            const el = (playerId===1) ? target.elA : target.elB;
            if(el) { 
                const tx = new WebKitCSSMatrix(window.getComputedStyle(el).transform).m41;
                el.style.transition = 'transform 0.1s ease-out, opacity 0.1s';
                el.style.transform = `translate(${tx}px, -150px) scale(1.5)`; el.style.opacity = 0;
            }
            if(auto) { processResult(playerId, 2, 'Perfect'); return; }
            const diff = Math.abs(target.time - curTime);
            if(diff <= HIT_GOOD) processResult(playerId, 2, 'Perfect');
            else if(diff <= HIT_OK) processResult(playerId, 1, 'Good');
            else processResult(playerId, 0, 'Review');
        }
    }

    function processResult(pid, val, label) {
        const s = (pid === 1) ? p1State : p2State;
        if(val > 0) {
            s.combo++; if(s.combo > s.maxCombo) s.maxCombo = s.combo;
            s.score += val * 100 + Math.min(s.combo, 100) * 10;
            let unit = 100 / (totalNotes || 1); if(totalNotes < 50) unit = 3;
            s.gauge = Math.min(100, s.gauge + (val===2 ? unit*1.2 : unit*0.8));
            if(val===2) s.good++; else s.ok++;
        } else {
            s.combo = 0; s.gauge = Math.max(0, s.gauge - 2); s.bad++;
        }
        updateUI(pid, label);
    }
    function updateUI(pid, label) {
        const s = (pid === 1) ? p1State : p2State;
        const d = (pid === 1) ? dom.p1 : dom.p2;
        d.score.innerText = s.score;
        d.gauge.style.width = `${s.gauge}%`;
        if(s.gauge >= 100) d.gauge.className = 'gauge-bar full'; else d.gauge.className = 'gauge-bar';
        if(s.combo >= 5) { d.combo.innerHTML = `${s.combo} Focus`; d.combo.style.opacity = 1; } else d.combo.style.opacity = 0;
        if(label) { 
            d.judge.innerText = label; 
            d.judge.style.color = (label==='Perfect'?'#f39c12':(label==='Good'?'#3498db':'#95a5a6')); 
            d.judge.style.animation = 'none'; d.judge.offsetHeight; d.judge.style.animation = 'flash 0.3s ease-out forwards'; 
        }
    }

    function quitGame() { isPlaying = false; bgm.pause(); cancelAnimationFrame(animId); backToSetup(); }
    function backToSetup() { document.getElementById('result-screen').style.display = 'none'; document.getElementById('session-screen').style.display = 'none'; document.getElementById('setup-screen').style.display = 'flex'; }
    function finishGame() {
        isPlaying = false; cancelAnimationFrame(animId);
        document.getElementById('session-screen').style.display = 'none'; document.getElementById('result-screen').style.display = 'flex';
        document.getElementById('res-score-p1').innerText = p1State.score; document.getElementById('res-rank-p1').innerHTML = `A:${p1State.good} / B:${p1State.ok} / C:${p1State.bad}`;
        if(mode === 2) {
            document.getElementById('res-p2').style.display = 'block'; document.getElementById('res-score-p2').innerText = p2State.score; document.getElementById('res-rank-p2').innerHTML = `A:${p2State.good} / B:${p2State.ok} / C:${p2State.bad}`;
            document.getElementById('res-p1').classList.remove('winner'); document.getElementById('res-p2').classList.remove('winner');
            if(p1State.score > p2State.score) document.getElementById('res-p1').classList.add('winner'); else if(p2State.score > p1State.score) document.getElementById('res-p2').classList.add('winner');
        } else { document.getElementById('res-p2').style.display = 'none'; }
    }

    function handleTouch(e, pid) { e.preventDefault(); const drum = (pid===1) ? dom.p1.drumFace : dom.p2.drumFace; for(let i=0; i<e.changedTouches.length; i++) { const t = e.changedTouches[i]; const target = document.elementFromPoint(t.clientX, t.clientY); if(target === drum || drum.contains(target)) { input(pid, 'type-a'); drum.style.transform = "scale(0.95)"; setTimeout(()=>drum.style.transform="scale(1)", 50); } else input(pid, 'type-b'); } }
    dom.p1.drumArea.addEventListener('touchstart', (e) => handleTouch(e, 1), {passive:false}); dom.p2.drumArea.addEventListener('touchstart', (e) => handleTouch(e, 2), {passive:false});
    window.addEventListener('keydown', e => { const k = e.key.toLowerCase(); if(k==='f'||k==='j') input(1, 'type-a'); if(k==='d'||k==='k') input(1, 'type-b'); });
</script>
</body>
</html>
    <!-- ▲▲▲ ここまで ▲▲▲ -->

    <!-- ページ下部に共通の「戻る」リンクだけ追加しておく -->
    <div style="text-align: center; margin: 20px;">
        <a href="game.html" style="display: inline-block; background-color: #007bff; color: #fff; padding: 12px 25px; text-decoration: none; border-radius: 5px; font-family: sans-serif;">ツール選択に戻る</a>
    </div>

</body>
</html>